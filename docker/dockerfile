# Use the rust image as the base image for the build stage
FROM rust:latest AS build

# Create a volume for the TEOS data directory
VOLUME ["~/.teos"]

# Set the working directory to /srv
WORKDIR /srv

# Copy the Rust-TEOS source code, excluding the watchtower-plugin directory
COPY . /srv/rust-teos

# Install the dependencies required by Rust-TEOS
RUN apt-get update && \
    apt-get -y --no-install-recommends install libffi-dev libssl-dev pkg-config && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN mkdir ~/.teos \
    && cd rust-teos \
    # Rustfmt is needed to format the grpc stubs generated by tonic.
    && rustup component add rustfmt \
    && cargo build --release

# Use a new stage with a smaller base image to reduce image size
FROM debian:buster-slim

WORKDIR /srv/rust-teos 

# Copy the teos binary from the build stage to the new stage
COPY --from=build /srv/rust-teos/target/release/ /usr/local/bin/

# Copy the entrypoint script to the container
COPY docker/entrypoint.sh /entrypoint.sh

# Set the entrypoint script as executable
RUN chmod +x /entrypoint.sh

# Expose the default port used by Rust-TEOS
EXPOSE 9814/tcp

# Start Rust-TEOS when the container starts
ENTRYPOINT [ "/entrypoint.sh" ]
