# Use the rust image as the base image
FROM rust:latest

# Create a volume for the TEOS data directory
VOLUME ["~/.teos"]

# Set the working directory to /srv
WORKDIR /srv

# Copy the Rust-TEOS source code, excluding the watchtower-plugin directory
ADD . /srv/rust-teos

# Install the dependencies required by Rust-TEOS
RUN apt-get update && \
    apt-get -y --no-install-recommends install libffi-dev libssl-dev pkg-config && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN mkdir ~/.teos \
    && cd rust-teos \
    #Rustfmt is needed to format the grpc stubs generated by tonic.
    && rustup component add rustfmt \
    && cargo build --release


WORKDIR /srv/rust-teos 

# Expose the default port used by Rust-TEOS
EXPOSE 9814/tcp

# Start Rust-TEOS when the container starts
ENTRYPOINT [ "/srv/rust-teos/docker/entrypoint.sh" ]
